FROM maven:3.8.5-openjdk-17 AS build

ARG GOOGLE_CLIENT_ID
ARG GOOGLE_CLIENT_SECRET

ARG SPRING_DATASOURCE_URL
ARG SPRING_DATASOURCE_USERNAME
ARG SPRING_DATASOURCE_PASSWORD

WORKDIR /app

ENV GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
ENV GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}

ENV SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
ENV SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
ENV SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}

COPY pom.xml /app/

RUN mvn dependency:resolve

COPY src /app/src/

RUN mvn clean package -Dmaven.test.skip=true

FROM openjdk:17

WORKDIR /app

COPY --from=build /app/target/server-app-0.0.1-SNAPSHOT.jar /app/

CMD ["java", "-jar", "server-app-0.0.1-SNAPSHOT.jar"]